#!/usr/bin/env node

let generateWebManifest = require('./steps/generate-web-manifest')
let downloadProject = require('./steps/download-project')
let findFilesInCSS = require('./steps/find-files-in-css')
let compressAssets = require('./steps/compress-assets')
let copyWellKnown = require('./steps/copy-well-known')
let compileAssets = require('./steps/compile-assets')
let repackScripts = require('./steps/repack-scripts')
let processGuides = require('./steps/process-guides')
let createLayout = require('./steps/create-layout')
let buildPages = require('./steps/build-pages')
let updateHtml = require('./steps/update-html')
let readJsdoc = require('./steps/read-jsdoc')
let buildApi = require('./steps/build-api')

async function build () {
  let assets = await compileAssets()
  let [webmanifest, filesFromCSS] = await Promise.all([
    generateWebManifest(assets),
    findFilesInCSS(assets),
    copyWellKnown(assets),
    repackScripts(assets),
    downloadProject('logux'),
    downloadProject('logux-core'),
    downloadProject('logux-server')
  ])
  let [guides, nodeJsdoc, uikit] = await Promise.all([
    processGuides(),
    readJsdoc('logux-core', 'logux-server'),
    updateHtml(assets, webmanifest, filesFromCSS)
  ])
  let layout = await createLayout(uikit)
  await Promise.all([
    buildPages(assets, layout, guides),
    buildApi(assets, layout, 'node-api', 'Node API', nodeJsdoc)
  ])
  await compressAssets(assets)
}

build().catch(e => {
  process.stderr.write(e.stack + '\n')
  process.exit(1)
})
